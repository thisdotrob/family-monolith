# Project Development Guide

## Project Overview

This is a full-stack application with three main components:
- **Backend Server**: Rust-based GraphQL API with JWT authentication
- **Web App**: React + TypeScript + Vite frontend with Tailwind CSS
- **Mobile App**: React Native + Expo cross-platform mobile application

All clients use Apollo GraphQL to communicate with the backend server.

## Architecture

### Backend (`server/`)
- **Language**: Rust (Edition 2024)
- **Framework**: Axum web server with async-graphql
- **Database**: SQLite with sqlx
- **Authentication**: JWT tokens with refresh token rotation
- **Security**: TLS/HTTPS with Let's Encrypt certificates
- **Deployment**: Docker containers or native binaries with systemd

### Web App (`webapp/`)
- **Framework**: React 19 + TypeScript
- **Build Tool**: Vite
- **Styling**: Tailwind CSS v4
- **Testing**: Vitest + Testing Library
- **GraphQL**: Apollo Client

### Mobile App (`mobileapp/`)
- **Framework**: React Native + Expo SDK 53
- **Navigation**: Expo Router with file-based routing
- **UI Library**: React Native Paper
- **Testing**: Jest + Testing Library React Native
- **GraphQL**: Apollo Client

## Key Directories and Files

### Backend Structure
- `src/lib.rs` - Main library entry point
- `src/bin/` - Executable binaries (dev.rs, migrate.rs, prod.rs)
- `src/auth/` - Authentication logic (JWT, passwords, guards, refresh tokens)
- `src/graphql/` - GraphQL schema and resolvers
- `src/server/` - HTTP server setup, middleware, routes
- `src/db/` - Database connection and helpers
- `migrations/` - SQL migration files
- `Cargo.toml` - Rust dependencies and configuration

### Frontend Structure (Both Web & Mobile)
- `src/contexts/AuthContext.tsx` - Authentication state management
- `src/pages/` - Main application pages (HomePage, LoginPage)
- `src/api/apollo.ts` - Apollo Client configuration
- `src/graphql/` - GraphQL queries and mutations
- `src/components/` - Reusable UI components

### Mobile-Specific
- `app/_layout.tsx` - Root layout with providers
- `app.json` - Expo configuration
- `assets/images/` - App icons and splash screens

### Web-Specific
- `src/App.tsx` - Root application component
- `vite.config.ts` - Vite build configuration
- `tailwind.config.cjs` - Tailwind CSS configuration

## Development Setup

### Backend
```bash
cd server
cargo run --bin migrate  # Run database migrations
cargo run --bin dev      # Start development server on port 4173
```

### Web App
```bash
cd webapp
npm install
npm run dev             # Start development server
npm run test           # Run tests
npm run build          # Build for production
```

### Mobile App
```bash
cd mobileapp
npm install
npx expo start         # Start Expo development server
npm run android        # Run on Android emulator
npm run ios           # Run on iOS simulator
npm test              # Run tests
```

## Authentication Flow

1. **Login**: Users authenticate via GraphQL mutation to `/v1/graphql/auth`
2. **Token Storage**: 
   - Web: localStorage
   - Mobile: AsyncStorage
3. **API Requests**: Authenticated requests go to `/v1/graphql/app`
4. **Token Refresh**: Automatic refresh token rotation on expiry
5. **Logout**: Clear tokens from storage

## GraphQL Endpoints

- `/v1/graphql/auth` - Unauthenticated operations (login, refresh)
- `/v1/graphql/app` - Authenticated operations (user data, protected mutations)

## Database

- **Type**: SQLite
- **File**: `blobfishapp.sqlite` (auto-created)
- **Migrations**: Located in `server/migrations/`
- **Schema**: Users table with id, username, password, first_name

## Configuration

### Backend Configuration (`server/src/config.rs`)
- Database path: `./blobfishapp.sqlite`
- JWT secret: Set `JWT_SECRET` environment variable in production
- TLS certificates: Configurable via `TLS_CERT_PATH` and `TLS_KEY_PATH`

### Development URLs
- Backend: `http://localhost:4173` (or `http://192.168.1.53:4173` for mobile)
- Web app: Vite dev server (typically `http://localhost:5173`)
- Mobile: Expo dev server

## Best Practices and Conventions

### Code Organization
- Use TypeScript for all frontend code
- Implement proper error handling with custom error types
- Follow React hooks patterns for state management
- Use GraphQL fragments for reusable query parts

### Authentication
- Always check authentication status before rendering protected content
- Implement loading states during token refresh
- Handle token expiry gracefully with automatic refresh
- Clear sensitive data on logout

### GraphQL
- Use Apollo Client cache effectively
- Implement optimistic updates where appropriate
- Handle loading and error states consistently
- Use proper TypeScript types for GraphQL operations

### Testing
- Write unit tests for utility functions
- Test React components with Testing Library
- Mock GraphQL operations in tests
- Test authentication flows thoroughly

### Security
- Never commit JWT secrets or certificates
- Use environment variables for sensitive configuration
- Implement proper CORS policies
- Validate all user inputs on the backend

### Mobile Development
- Use React Native Paper for consistent UI
- Handle platform differences appropriately
- Test on both iOS and Android
- Use Expo's built-in features when possible

### Backend Development
- Use proper error handling with custom AppError types
- Implement database transactions where needed
- Add proper logging with tracing
- Use guards for GraphQL endpoint protection

## Common Commands

### Backend
```bash
cargo build --release                    # Production build
cargo run --bin migrate                  # Run migrations
cargo test                              # Run tests
```

### Frontend (Web/Mobile)
```bash
npm run lint                            # Run ESLint
npm run test                           # Run tests
npm run build                          # Production build
```

### Mobile Specific
```bash
npx expo install                       # Install Expo dependencies
npx expo prebuild                      # Generate native code
npm run reset-project                  # Reset to blank project
```

## Deployment

### Backend
- Docker deployment recommended (see `server/DEPLOY.md`)
- Systemd service files provided in `server/deploy/`
- Requires Let's Encrypt certificates for HTTPS

### Web App
- Build with `npm run build`
- Deploy static files from `dist/` directory
- Configure web server to serve SPA routes

### Mobile App
- Build with Expo Application Services (EAS)
- Submit to app stores via EAS Submit
- Configure app.json for store requirements

## Troubleshooting

### Common Issues
- **CORS errors**: Check backend CORS configuration
- **Token refresh loops**: Verify refresh token mutation logic
- **Database connection**: Ensure SQLite file permissions are correct
- **Mobile network**: Use correct IP address for backend in development

### Development Tips
- Use browser dev tools for GraphQL debugging
- Check Expo logs for mobile debugging
- Monitor backend logs with tracing output
- Use Apollo Client DevTools for GraphQL inspection